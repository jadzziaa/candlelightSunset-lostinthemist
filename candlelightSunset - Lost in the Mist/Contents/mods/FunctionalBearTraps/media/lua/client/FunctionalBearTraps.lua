--[[⠀
----------------------------------------------------------------------------------------------------------------------------⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀                       ⠀⢀⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⣀⣀⣀⣀⣀⣀⣰⣦⣀⣀⠀⠠⠄⠄⠠⠀⠀⢀⣠⣤⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣾⡏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⣶⡿⢿⣦⠀⠀⠀⠀⠀⠀⠀⢀⡷⠀⠀⠀⠀⠀⣀⠀⠀⠀⠀⠀⣩⡿⠋⠙⠉⢩⡿⠟⠀⠀⠀⠀⠀⠀⢀⣶⣾⠟⠋⠛⣿⣷⡄⠀⠀⠀⠀⠀⣴⣿⠂⠀⠀⣼⡿⠀⠀⠀⠀⠀⠀⢀⣠⡴⠶⣤⠀⠀⠀⠀⠀⠀⠀⠀⣠⣴⠦⠤⣤⣤⣀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⢀⣼⡿⠋⠀⢸⠏⠀⠀⠀⠀⠀⠀⠀⣼⠃⠀⠀⠀⠀⢠⡇⠀⠀⠀⢠⣾⠋⠀⠀⠀⠀⣸⠀⠀⠀⠀⠀⠀⠀⢠⣿⠋⠀⠀⠀⠀⠛⠛⠁⠀⠀⠀⢀⣾⣿⠏⠀⠀⢀⡿⠃⠀⠀⠀⠀⠀⠶⠋⠁⢀⣰⠟⠀⠀⠀⠀⠀⠀⠀⣹⣿⠀⠀⠀⠀⣨⣿⠇⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⣾⡟⢀⣠⣤⣴⣶⠆⠀⠀⠀⠀⠀⢰⠃⠀⠀⠀⠀⠀⣾⠀⠀⠀⣰⣿⠃⠀⠀⠀⠀⠀⣿⡀⠀⠀⠀⠀⠀⢀⣿⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣸⣿⠋⠀⠀⢀⡾⠁⠀⠀⠀⠀⠀⠀⠀⣠⣶⣯⣅⡀⠀⠀⠀⠀⠀⠀⠀⣿⡇⢀⣠⠴⠞⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⣸⡟⠀⠛⠉⣠⣾⠃⠀⠀⠀⠀⠀⠀⣼⠀⠀⠀⠀⠀⠀⢿⣤⡴⢺⢻⠃⠀⠀⠀⠀⠀⢸⡿⠁⠀⠀⠀⠀⠀⠀⢿⠀⠀⠀⠀⢀⣤⠀⠀⠀⠀⠀⢀⣿⣇⡤⠤⢤⣾⣤⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠙⢻⡆⠀⠀⠀⠀⠀⣿⣯⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⣿⠃⠀⠀⢀⣼⠇⠀⠀⠀⠀⠀⠀⣰⠏⠀⠀⠀⠀⠀⠀⠀⠀⠀⢂⠇⠀⠀⠀⠀⠀⠀⣾⡅⠀⠀⠀⠀⠀⠀⠀⢸⣧⡀⠀⠀⣼⠇⠀⠀⠀⠀⠀⢸⣿⠀⠀⠀⠐⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⠃⠀⠀⠀⠀⠀⢰⡏⠘⣦⠀⠀⠀⠀⡀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠘⢧⣤⡶⠟⢻⠀⠀⠀⠀⠀⠀⢠⡏⠀⠀⠀⠀⠀⠀⠀⠀⠀⢘⠏⠀⠀⠀⠀⠀⠀⢰⣿⡄⠀⠀⠀⠀⠀⠀⠀⠀⠙⠿⣶⡾⠋⠀⠀⠀⠀⠀⠀⢸⡟⠀⠀⠀⢰⠇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⠞⠁⠀⠀⠀⠀⠀⠀⠁⠀⠈⠙⠂⠔⠊⠁⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⠀⠀⠀⠀⠀⢀⣿⣤⠶⠒⠒⠁⠀⠀⠀⠀⢠⠏⠀⠀⠀⠀⠀⠀⠀⠀⠈⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠀⠀⠀⠀⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠄⠐⠊⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⡿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀

----------------------------------------------------------------------------------------------------------------------------
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
Please contact me if you need to hire someone to do mods or other design related tasks
https://steamcommunity.com/id/glytch3r/myworkshopfiles/
https://www.glytch3r.com
https://ko-fi.com/glytch3r
Discord: Glytch3r#2892

----------------------------------------------------------------------------------------------------------------------------
--]]

require "lua_timers"
require "recipecode"


Recipe = Recipe or {}
Recipe.GetItemTypes = Recipe.GetItemTypes or {}
Recipe.OnCanPerform = Recipe.OnCanPerform or {}
Recipe.OnCreate = Recipe.OnCreate or {}
Recipe.OnGiveXP = Recipe.OnGiveXP or {}
Recipe.OnTest = Recipe.OnTest or {}

function RemoveBearTrapData()
    if getPlayer():getModData()['plDisabled'] == true then 
        getPlayer():getModData()['plDisabled'] = nil 
        ISTimedActionQueue.clear(getPlayer())
    end
end

do
    local old_isValid = ISWearClothing.isValid
    function ISWearClothing:isValid()
        return not (getPlayer():getModData()['plDisabled']) and old_isValid(self)
    end
end

do
    local old_isValid = ISUnequipAction.isValid
    function ISUnequipAction:isValid()
       return not (getPlayer():getModData()['plDisabled']) and old_isValid(self)
    end
end




local snareOpen = 'constructedobjects_01_20' --20 open 
local snareClose = 'constructedobjects_01_21' --21 close

local function TrapSideInjured()
local roll =  ZombRand(1,2+1) 
    if roll == 1 then
    return 'LowerLeg_R'
    elseif roll == 2 then
    return'LowerLeg_L'
    end
end
------------------------               ---------------------------
function BearTrapDamager()
  BearTrapStunner()
    local NumberOfInjury = ZombRand(1,3+1)
    local chr = getPlayer() 
    chr:getStats():setPanic(chr:getStats():getPanic() + 50+NumberOfInjury)  
    
    chr:setIgnoreMovement(true) 
    local bd =  chr:getBodyDamage()
    
    for i = 0, NumberOfInjury -1 do
        local sidepartpick = TrapSideInjured()
        local roll =  ZombRand(1,4+1) 
        if  roll == 1 then bd:getBodyPart(BodyPartType.sidepartpick):setBleedingTime(100); addBloodSplat(chr:getSquare() , 15); end
        if  roll == 2 then bd:getBodyPart(BodyPartType.sidepartpick):setFractureTime(100) end
        if  roll == 3 then bd:getBodyPart(BodyPartType.sidepartpick):setDeepWoundTime(100) end
        if  roll == 4 then chr:getStats():setPanic(chr:getStats():getPanic() + 20)  end
    end
end

function BearTrapStunner()
local StagDuration = SandboxVars.FunctionalBearTraps.StagDuration
    local pl = getPlayer()
    pl:setBumpType("stagger");
    pl:setVariable("BumpDone", true);
    pl:setVariable("BumpFall", true);
    pl:setVariable("BumpFallType", "pushedbehind");        
    pl:setIgnoreMovement(true)
    pl:setIgnoreInputsForDirection(true);
    pl:Callout(true);
    
    timer:Simple(1, function()
        pl:setBumpFallType("FallForward")
        pl:setBumpType('stagger')
        pl:setBumpDone(false)
        pl:setBumpFall(true)
        pl:reportEvent("wasBumped")
        pl:playEmote("BearTrapped") 
        pl:getModData()['plDisabled'] = true

        pl:setVariable("BumpFallType", "");       
        pl:setVariable("BumpFall", false);

        --pl:setVariable("BumpDone", true)
            timer:Simple(StagDuration, function()
                pl:setIgnoreInputsForDirection(false);
                pl:setIgnoreMovement(false)
                ISTimedActionQueue.clear(pl)
                pl:getModData()['plDisabled'] = nil
                pl:setVariable("BumpFallType", "pushedFront");    
                pl:setVariable("BumpDone", true)
                pl:reportEvent("wasBumped") 
            end) 
    end)
end


local function BearTrapActivate()

local isPlstag = SandboxVars.FunctionalBearTraps.SnarePl
if not getPlayer() or isPlstag == false then return end

local sq = getPlayer():getSquare() 
    for i=0, sq:getObjects():size()-1 do
    local obj = sq:getObjects():get(i)
        local spr = obj:getSprite():getName()
       -- print(spr)
            if spr == snareOpen then 
                BearTrapDamager(obj)
                getSoundManager():PlayWorldSound('BearTrapSound', getPlayer():getSquare(), 0, 5, 5, false);  
                addSound(getPlayer(), getPlayer():getX(), getPlayer():getY(), getPlayer():getZ(), 5, 1)
                obj:setSprite(snareClose)
                obj:getSprite():setName(snareClose)
                obj:transmitUpdatedSpriteToServer();
                obj:transmitUpdatedSpriteToClients();
                if isClient() then obj:transmitCompleteItemToServer(); end
                getPlayerLoot(0):refreshBackpacks()   
                
            end
    end
end


local function isNearBearTrap()
if not getPlayer() then return end
    local checker = false
    local rad = 1
    local pl = getPlayer() 
    local cell = pl:getCell();
    local x, y, z = pl:getX(), pl:getY(), pl:getZ() 
    local xx, yy, zz 
    for xx = -rad, rad do 
    for yy = -rad, rad do
    local sq = cell:getGridSquare(x + xx, y + yy, z) 
        for i=0, sq:getObjects():size()-1 do
        local obj = sq:getObjects():get(i) 
        local spr = obj:getSprite():getName()
            if spr == snareOpen  or spr == snareClose then
               checker= true
            end
        end 
    end 
    end 
    return checker
end 

local function isReachedTrap()
if not getPlayer() then return end
        local adj = getPlayer():getSquare():getAdjacentSquare(getPlayer():getDir()); 
        for i=0, adj:getObjects():size()-1 do
        local obj = adj:getObjects():get(i) 
        local spr = obj:getSprite():getName()
            if spr == snareOpen  or spr == snareClose then
               checker= true
            end
        end 
end 
        

         
        function takeBearTrap(obj)
            local pl = getPlayer()
            getPlayer():playEmote("looplootlow") 
            timer:Simple(3, function() 
  
                    getPlayer():playEmote("") 
                    sledgeDestroy(obj)
                    obj:getSquare():transmitRemoveItemFromSquare(obj) 
                    getPlayer():getInventory():AddItem('fBT.BearTrapOpen') 
                    getSoundManager():PlayWorldSound('BearTrapSetupSound', pl:getSquare(), 0, 5, 5, false);  
                    addSound(pl, pl:getX(), pl:getY(), pl:getZ(), 5, 1)

           
            end)
        end
        function disarmBearTrap(obj)
            local pl = getPlayer()
           getPlayer():playEmote("looplootlow") 
            timer:Simple(3, function() 
                getPlayer():playEmote("") 
                getSoundManager():PlayWorldSound('BearTrapSound', pl:getSquare(), 0, 5, 5, false);  
                addSound(pl, pl:getX(), pl:getY(), pl:getZ(), 5, 1)
                obj:setSprite(snareClose)
                obj:getSprite():setName(snareClose)
                obj:transmitUpdatedSpriteToServer();
                obj:transmitUpdatedSpriteToClients();
                if isClient() then obj:transmitCompleteItemToServer(); end
                getPlayerLoot(0):refreshBackpacks()  
            end)
        end


function isNothingThere() 
    local pl = getPlayer() 
    local square = pl:getSquare():getAdjacentSquare(pl:getDir())
    
	if not square then return false end
	
    --if square:isSomethingTo(pl:getSquare()) then return false end
	if pl:getCurrentSquare():isBlockedTo(square) then return false end
	if square:isSolid() or square:isSolidTrans() then return false end
	if square:HasStairs() then return false end
	if square:HasTree() then return false end
	if not square:getMovingObjects():isEmpty() then return false end
	if not square:TreatAsSolidFloor() then return false end
	--if not self:haveMaterial(square) then return false end
	for i=1,square:getObjects():size() do
		local obj = square:getObjects():get(i-1)
		if obj:getSprite() == obj:getTextureName() then return false end
    end
    if buildUtil.stairIsBlockingPlacement( square, true ) then return false; end
	if square:isVehicleIntersecting() then return false end
	return true
end


--[[     local pl = getPlayer() 
    local sq = pl:getSquare() 
    local adj = pl:getSquare():getAdjacentSquare(pl:getDir())
    if not pl:getCurrentSquare():isBlockedTo(adj) then
    return adj:isSomethingTo(sq)
    else return false end 
    end
]]



   
    
    
function SetBearTrap()
    if not isNothingThere() == true then 
    getPlayer():Say('cannot place there') 
    return 
    end
    local pl = getPlayer() 
    getSoundManager():PlayWorldSound('BearTrapSetupSound', pl:getSquare(), 0, 5, 5, false);  
    addSound(pl, pl:getX(), pl:getY(), pl:getZ(), 5, 1)
    local square = pl:getSquare():getAdjacentSquare(pl:getDir())
    local object = IsoObject.new(square, "constructedobjects_01_20", "constructedobjects_01_20", false)
    square:AddTileObject(object)
    if isClient() then 
    object:transmitCompleteItemToServer(); 
    object:transmitCompleteItemToClients()
    end
    
    getPlayerLoot(0):refreshBackpacks()   
end
		--ISTimedActionQueue.add(ISReadWorldMap:new(getPlayer()))
local function BearTrapContextMenu(player, context, worldobjects, test)
--[[ 
local snareOpen = 'constructedobjects_01_20' --20 open 
local snareClose = 'constructedobjects_01_21' --21 close 
]]
local pl = getPlayer()
  if test and ISWorldObjectContextMenu.Test then return true end
    local menuCreated = false
  	local sq = nil
    for _, obj in ipairs(worldobjects) do
        --local obj = square:getObjects():get(i) 
        local spr = obj:getSprite():getName()
        if instanceof(obj, "IsoObject")  then
            if spr == snareOpen and not menuCreated then 
          
                context:addOption('Disarm Bear Trap', obj,  
                (function() 
                    local pl = getPlayer() 
                    local adj = AdjacentFreeTileFinder.Find(obj:getSquare(), pl);
                    ISTimedActionQueue.add(ISWalkToTimedAction:new(pl, adj));
                    
                    timer:Create("reachedBearTrap", 1, 0, 
                    function() 
                        local csq = pl:getCurrentSquare() 
                        if csq == adj then
                        pl:faceLocation(obj:getX(), obj:getY())    
                       pl:playEmote("looplootlow")  
                            
                        timer:Simple(1, function() timer:Remove("reachedBearTrap"); disarmBearTrap(obj) end) 
                            
                        end
                    end) 
                  
                    end))
            end
            if spr == snareClose and not menuCreated then 
      
                context:addOption('Take Bear Trap', obj,  
                               (function() 
                               
                    local pl = getPlayer() 
                    local adj = AdjacentFreeTileFinder.Find(obj:getSquare(), pl);
                    ISTimedActionQueue.add(ISWalkToTimedAction:new(pl, adj));
                    
                    timer:Create("reachedBearTrap", 1, 0, 
                    function() 
                    
                        local csq = pl:getCurrentSquare() 
                        if csq == adj then
                        pl:faceLocation(obj:getX(), obj:getY())    
                        pl:playEmote("looplootlow") 
                            
                           timer:Simple(1, function() timer:Remove("reachedBearTrap"); takeBearTrap(obj) end) 
                            
                        end
                    end) 
                    end))
           
            end
            --[[ if spr == snareClose and not menuCreated then                 
                context:addOption('Take Bear Trap', obj,  (function()                     
                    local pl = getPlayer() 
                    local adj = AdjacentFreeTileFinder.Find(obj:getSquare(), pl);
                    ISTimedActionQueue.add(ISWalkToTimedAction:new(pl, adj));
                    timer:Create("reachedBearTrap", 1, 0, function() 
                        local csq = pl:getCurrentSquare() 
                        if csq == adj then
                            takeBearTrap(obj)
                            timer:Remove("reachedBearTrap"); 
                        end
                    end) 
                end))                
            end ]]
        end
    menuCreated = true
    end
end



--[[ local function zedSnared(zombie)
if not zombie then return end
local sq = zombie:getSquare()
    for i=0, sq:getObjects():size()-1 do
    local obj = sq:getObjects():get(i)
        local spr = obj:getSprite():getName()
       -- print(spr)
            if spr == snareOpen then 
                zombie:knockDown(hitFromBehind)
                getSoundManager():PlayWorldSound('BearTrapSound', zombie:getSquare(), 0, 5, 5, false);  
                addSound(zombie, zombie:getX(), zombie:getY(), zombie:getZ(), 5, 1)
                obj:setSprite(snareClose)
                obj:getSprite():setName(snareClose)
                obj:transmitUpdatedSpriteToServer();
                obj:transmitUpdatedSpriteToClients();
                if isClient() then obj:transmitCompleteItemToServer(); end
                getPlayerLoot(0):refreshBackpacks()   
            end
    end
end
Events.OnZombieUpdate.Add(zedSnared)  ]]

Events.OnFillWorldObjectContextMenu.Add(BearTrapContextMenu) 
Events.OnPlayerMove.Add(BearTrapActivate)
Events.OnGameStart.Add(RemoveBearTrapData)





--Events.OnContainerUpdate.Add(FunctionalATMs.checkIfGold)

------------------------               
--[[ function GlytchMenu(key)
if (key==199) then --home
print('glytch3r')
if not (getCore():getDebug() or isAdmin()) then return; end 
BrushToolManager.openPanel(getPlayer())
	return key
	end
end

Events.OnKeyPressed.Add(GlytchMenu); ]]
